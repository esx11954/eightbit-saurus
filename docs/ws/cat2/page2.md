---
sidebar_position: 2
---

# Active Directory演習

このページでは**Active Directory Domain Service**(以降ADDS)の主要な機能を紹介しています。  
記載されている手順を参考に、実際に手を動かして理解を深めましょう。  


<details>
    <summary>1. ADインストール</summary>
    <div>
まずは構築したWindows ServerにADDSの機能サーバーマネージャーを起動し、`管理` から` 役割と機能の追加` をクリックしてください。


![ad](./ADIMG1/1.png)

役割と機能の追加をする際の注意の画面が出てきます。  
確認したら `次へ` をクリック。  

:::caution
インストール作業を開始する前に、以下を確認してください。  
- IPアドレスが固定されていること(DHCPではなくスタティックで設定)
- WindowsUpdateが実行されていること
:::

![ad](./ADIMG1/2.png)

`役割ベースまたは機能ベースのインストール`がチェックされていることを確認し、`次へ` をクリック。  

![ad](./ADIMG1/3.png)

インストールするサーバを選択する画面です。  
操作中のサーバにインストールするので、サーバープールから該当端末を選択して `次へ` をクリック。  

![ad](./ADIMG1/4.png)

インストールする役割を選択します。  
画面中央の `Active Directory ドメインサービス` の左部分のチェックボックスをクリック。

![ad](./ADIMG1/5.png)

確認画面が表示されるので、`機能の追加` をクリック。

![ad](./ADIMG1/6.png)

画面中央の `Active Directory ドメインサービス` の左部分のチェックボックスに、チェックが入っていることを確認し、`次へ` をクリック。  

![ad](./ADIMG1/7.png)

特に操作せず `次へ` をクリック。  

![ad](./ADIMG1/8.png)

特に操作せず `次へ` をクリック。  

![ad](./ADIMG1/9.png)

以下画像と同じ様に表示されていることを確認し、`インストール` をクリック。

![ad](./ADIMG1/10.png)

インストール完了後、画面中央に `このサーバーをドメインコントローラーに昇格する` というリンクが表示されるので、これをクリック。

:::tip
ADDS（Active Directory Domain Services）におけるドメインコントローラー（DC）は、ユーザーやコンピューターなどの情報（アカウント）を一元管理し、認証を行うサーバーです。  

簡単に言うと、「誰が」「どのコンピューターで」「何ができるか」 を管理する、ネットワークの中心的な存在です。  
DCがないと、ネットワークに参加するたびに個別の設定が必要になり、セキュリティも低下します。

今回は研修ですのでシングルドメインコントローラー構成で進行しますが、以下の特性を知識として持っておきましょう。  

ドメインコントローラーが故障した場合
- ドメイン全体の認証
- グループポリシーの適用
- SYSVOLへのアクセス 

などが完全に停止してしまいます。  
これは、業務継続に深刻な影響を与えます。

また全ての認証要求や管理操作が1台のサーバーに集中するため、  
負荷が高くなり、パフォーマンスの低下を招く可能性があります。  
特にユーザー数やコンピューター数が増加すると顕著になります。

上記のように、シングルドメインコントローラー環境は、可用性、パフォーマンス、信頼性の他、セキュリティの観点からも一般的には**推奨されません**。
:::

![ad](./ADIMG1/11.png)

`新しいフォレストを追加する` がチェックされていることを確認し、`ルートドメイン名` を **eightbit.local** に設定します。  
入力が完了したら `次へ` をクリック。  

:::tip

フォレストとは、ADDSにおける最も大きな管理単位です。  
ルートドメインとは、フォレスト内で最初に作成される特別なドメインで、フォレストの作成時に必ず1つだけ存在し、フォレスト全体の基礎となります。

:::

![ad](./ADIMG1/12.png)

`フォレストの機能レベル` はそのままで、`ディレクトリ復元モードのパスワード` は **P@ssw0rdd_** を入力してください。  
入力が完了したら `次へ` をクリック。  

:::tip
フォレストの機能レベルとは、フォレスト全体で利用できるAD DSの機能の範囲を示すものです。  
わかりやすく例えるなら、フォレスト全体のAD DSの「バージョン」 のようなものです。  

機能レベルを上げると、新しいバージョンのWindows Serverで導入された高度な機能がフォレスト全体で利用できるようになります。  
フォレストの機能レベルは、フォレスト内のすべてのドメインコントローラーが満たす必要のある最低限のWindows Serverのバージョンを決定します。  

例えば、フォレスト機能レベルが「Windows Server 2016」の場合、フォレスト内のすべてのドメインコントローラーはWindows Server 2016以上である必要があります。  
上記の場合、古いバージョンのドメインコントローラーはフォレストに参加できなくなるので注意が必要です。

:::

![ad](./ADIMG1/13.png)

特に操作せず `次へ` をクリック。 

![ad](./ADIMG1/14.png)

黄色ハイライト箇所は自動的に入力されます。  
特に操作せず `次へ` をクリック。 

:::tip
NetBIOSドメイン名は、昔ながらのWindowsネットワークで使われていた短い識別名です。  
現代のネットワークではDNSドメイン名が主流ですが、互換性のためにNetBIOSドメイン名も依然として存在することがあります。  
DNSドメイン名がインターネット全体で使われるグローバルな名前であるのに対し、NetBIOSドメイン名は主にローカルネットワーク内で機能します。

例えば、DNSドメイン名が example.com の場合、NetBIOSドメイン名は EXAMPLE のようになることが多いです。（すべて大文字で表現されるのが一般的です）
:::

![ad](./ADIMG1/15.png)

AD DSの各種ファイルの保存先を設定する画面です。  
デフォルトのまま、`次へ` をクリック。 

:::tip
SYSVOLは、Active Directoryドメインにおける共有設定情報の中央保管場所であり、すべてのドメインコントローラー間で自動的に同期される、非常に重要な仕組みです。  
グループポリシーやスクリプトなどを一元管理し、ドメイン全体の整合性を保つ役割を担っています。  

SYSVOLが正常に機能していないと、以下のような問題が発生する可能性があります。

- グループポリシーがクライアントコンピューターに適用されない
- ログオンスクリプトなどが実行されない
- ドメインへのログオンに失敗する
:::

![ad](./ADIMG1/16.png)

設定項目の確認画面が表示されます。  
確認できたら `次へ` をクリック。 

![ad](./ADIMG1/17.png)

インストールするための前提条件がチェックされます。  
チェックが完了すると `インストール` が活性化するのでクリック。 
以上でAD DSのインストールは完了です。

![ad](./ADIMG1/18.png)

サーバーマネージャーの役割とサーバーグループ欄に、`AD DS` と `DNS` が表示されていれば正常に完了しています。

![ad](./ADIMG1/19.png)


</div>
</details>


<details>
    <summary>2. OU(組織単位)作成</summary>
    <div>

サーバーマネージャーを起動し、`ツール` から`Active Directory 管理センター` をクリックしてください。

![ad](./ADIMG2/1.png)

左ペインのドメイン(eightbit)を右クリック > `新規` > `組織単位` をクリック。

![ad](./ADIMG2/2.png)

組織単位の作成画面が立ち上がるので、名前欄に `Sales` と入力し、`OK` をクリック。

![ad](./ADIMG2/3.png)

管理センター画面で **Sales** という名前のOUが作成されていることを確認しましょう。

![ad](./ADIMG2/4.png)


</div>
</details>

<details>
    <summary>3. ユーザオブジェクト作成</summary>
    <div>

Active Directory管理センター を開き、作成したOU(今回はSales)を右クリック > `新規` > `ユーザー` をクリック。

![ad](./ADIMG2/5.png)

ユーザーの作成画面が開くので、黄色い箇所を画像と同じように入力します。  
パスワードは `P@ssw0rdd_` と入力してください。  
完了したら `OK` をクリック。

![ad](./ADIMG2/6.png)

Active Directory管理センターで作成ユーザが表示されていることを確認してください。

![ad](./ADIMG2/7.png)

同じ要領でもう一つユーザオブジェクトを作成します。  
先ほどと同様に画像と同じように入力します。  
パスワードは `P@ssw0rdd_` と入力してください。  
完了したら `OK` をクリック。

![ad](./ADIMG2/8.png)


</div>
</details>

<details>
    <summary>4. グループオブジェクト作成</summary>
    <div>

Active Directory管理センター画面を開き、左ペインのOU(今回はSales)をクリックし、右クリック > `新規` > `グループ` をクリック。

![ad](./ADIMG2/9.png)

ユーザーの作成画面が開くので、黄色い箇所を画像と同じように入力します。  
入力が完了したら、管理者エリアの `編集` ボタンをクリック。

![ad](./ADIMG2/10.png)

この画面では作成するグループの管理者を決定します。  
選択するオブジェクト名のテキストエリアに「sales」と入力し、`名前の確認` をクリック。

![ad](./ADIMG2/11.png)

営業部管理者のオブジェクトが表示されることを確認し、`OK` をクリック。

![ad](./ADIMG2/12.png)

管理者欄に選択したオブジェクト名が表示されていることを確認し、`OK` をクリック。

![ad](./ADIMG2/13.png)

グループが作成できたので、次は特定のユーザオブジェクトをグループに追加します。
作成したユーザオブジェクトを右クリック > `グループに追加` をクリック。

![ad](./ADIMG2/14.png)

選択するオブジェクト名のテキストエリアに「営業一課」と入力し、`名前の確認` をクリック。

![ad](./ADIMG2/15.png)

管理者欄に選択したオブジェクト名が表示されていることを確認し、`OK` をクリック。

![ad](./ADIMG2/16.png)

先ほどのユーザオブジェクトがグループに追加されていることを確認するため、ユーザのプロパティを開いてください。

![ad](./ADIMG2/17.png)

所属するグループエリアに先ほどの設定が反映されていることを確認しましょう。

![ad](./ADIMG2/18.png)

</div>
</details>

<details>
    <summary>5. オブジェクト制御委任</summary>
    <div>

サーバーマネージャーを起動し、`ツール` から`Active Directory ユーザーとコンピューター` をクリックしてください。

![ad](./ADIMG3/1.png)

左ペインのドメイン(`eightbit.local`) > OU(`Sales`)を右クリックし、 `制御の委任` をクリック。

![ad](./ADIMG3/2.png)

オブジェクト制御の委任ウィザード画面が表示されるので、`次へ` をクリック。

![ad](./ADIMG3/3.png)

`追加` をクリック。

![ad](./ADIMG3/4.png)

選択するオブジェクト名のテキストエリアに「営業部」と入力し、`名前の確認` をクリック。

![ad](./ADIMG3/5.png)

選択したオブジェクト名(営業部管理者)が表示されていることを確認し、`OK` をクリック。

![ad](./ADIMG3/6.png)

画像と同じように選択したオブジェクトが表示されていることを確認し、`次へ` をクリック。

![ad](./ADIMG3/7.png)

委任するタスク画面では、`ユーザーアカウントの作成、削除、および管理` にチェックを入れて `次へ` をクリック。

![ad](./ADIMG3/8.png)

内容を確認し、`完了` をクリック。
以上で制御の委任は完了です。

![ad](./ADIMG3/9.png)

</div>
</details>

<details>
    <summary>オブジェクトの監査</summary>
    <div>

サーバーマネージャーを起動し、`ツール` から`グループポリシーの管理` をクリックしてください。

![ad](./ADIMG4/1.png)

`フォレスト` > `ドメイン` > `eightbit.local` > `グループポリシーオブジェクト` をクリック。  
`Default Domain Policy` を右クリックし、`編集` をクリック。

![ad](./ADIMG4/2.png)

グループポリシー管理エディターが表示されます。  
`コンピューターの構成` > `ポリシー` > `Windowsの設定` > `セキュリティの設定` > `ローカルポリシー` > `監査ポリシー` をクリックし。  
右側に表示される `ディレクトリサービスのアクセスの監査` を右クリックし `プロパティ` をクリック。

![ad](./ADIMG4/3.png)

ディレクトリサービスのアクセスの監査プロパティ画面が表示されます。  
`これらのポリシーの設定を定義する` にチェックを入れ、`成功` にチェックを入れ、`OK` をクリック。

![ad](./ADIMG4/4.png)

アクティブディレクトリ管理センターを開き、設定するOU(今回はSales)のプロパティをクリック。

![ad](./ADIMG4/5.png)

OUのプロパティ画面の `拡張` の `セキュリティ` タブを開き、`詳細設定` をクリック。

![ad](./ADIMG4/6.png)

セキュリティの詳細設定画面が表示されます。  
監査タブを開き、`追加` をクリック。

![ad](./ADIMG4/7.png)

監査エントリ画面です。  
`プリンシパルの選択` をクリック。

![ad](./ADIMG4/8.png)

オブジェクトの選択画面になるので、「auth」と入力し、`名前の確認` をクリック。

![ad](./ADIMG4/9.png)

`Authenticated Users` が表示されていることを確認し、`OK` をクリック。

![ad](./ADIMG4/10.png)

適用先を `子ユーザーオブジェクト` に変更し、プロパティの `すべてのプロパティの書き込み` にチェックを入れ、`OK` をクリック。

![ad](./ADIMG4/11.png)

先程の設定が反映されていることを確認し、`OK` をクリック。

![ad](./ADIMG4/12.png)

OUのプロパティ画面では `キャンセル` をクリックして閉じて下さい。

![ad](./ADIMG4/13.png)

動作確認

特定のユーザーオブジェクトのプロパティの値を、以下の画像と同じように編集して下さい。

![ad](./ADIMG4/14.png)

Windowsキーを押下し、イベントビューアーを開きます。

![ad](./ADIMG4/15.png)

`Windowsログ` > `セキュリティ` をクリックします。  
中央上部にイベント一覧が表示されるので、その中からタスクのカテゴリが「Directory Service Access」のものを探して下さい。  
画像と同じ様なイベントがログとして残っていることを確認しましょう。

![ad](./ADIMG4/16.png)

</div>
</details>

<details>
    <summary>グループポリシー</summary>
    <div>

グループポリシーの管理画面から、`フォレスト` > `ドメイン` > `eightbit.local` > `グループポリシーオブジェクト` を右クリックし、`新規` をクリック。

![ad](./ADIMG5/1.png)

新たに作成するGPOの名前を決定します。  
`logon script` と入力し、`OK` をクリック。

![ad](./ADIMG5/2.png)

作成したGPOを右クリックし、`編集` をクリック。

![ad](./ADIMG5/3.png)

グループポリシー管理エディター画面が表示されます。  
`ユーザーの構成` > `ポリシー` > `Windowsの設定` > `スクリプト` をクリック。  
右ペインの `ログオン` を右クリックし、プロパティを開きます。

![ad](./ADIMG5/4.png)

ログオンのプロパティ画面が表示されます。  
`追加` ボタンをクリック。

![ad](./ADIMG5/5.png)

以下の画面では `参照` をクリック。

![ad](./ADIMG5/6.png)

**参照画面**が開きますが、この時 `上部に表示されているパス` をコピーして下さい。  

![ad](./ADIMG5/7.png)

**新たにエクスプローラを立ち上げて下さい。**  
先程コピーしたパスにアクセスして下さい。  

![ad](./ADIMG5/8.png)

表示タブを開き、`ファイル名拡張子` にチェックを入れます。 

![ad](./ADIMG5/8.5.png)

画面中央部辺りで右クリック > `新規作成` > `テキストドキュメント` をクリック。

![ad](./ADIMG5/9.png)

ファイル名を `startup.bat` と編集して名前を変更して下さい。

![ad](./ADIMG5/10.png)

作成したファイルを右クリックし、 `編集` をクリック。

![ad](./ADIMG5/11.png)

ファイル内に以下を追記して下さい。

```bash
@echo off
echo %date% %time% にログオンスクリプトが実行されました。 >> %userprofile%\desktop\logon_script.log
```

![ad](./ADIMG5/12.png)

**参照画面** に戻り、startup.batを選択した状態で `開く` をクリック。

![ad](./ADIMG5/13.png)

スクリプト名欄に作成したファイル名が表示されていることを確認して `OK` をクリック。

![ad](./ADIMG5/14.png)

以下の画面でも同じくファイル名を確認し、`OK` をクリック。

![ad](./ADIMG5/15.png)

作成したGPOをOUにリンクします。  
グループポリシーの管理画面から、`Sales` を右クリックし、`既存のGPOをリンク` をクリック。

![ad](./ADIMG5/16.png)

先ほど作成した `logon script` を選択し、 `OK` をクリック。

![ad](./ADIMG5/17.png)

OUの下に選択したGPOが表示されていることを確認して下さい。

![ad](./ADIMG5/18.png)

ドメインに所属する検証用クライアントPCから、GPOをリンクしたOUに所属するユーザアカウントでログインし、以下を確認して下さい。
- デスクトップにlogon_script.logというファイルが作成されていること
- ファイルの内容としてログイン日次が表示されていること

![ad](./ADIMG5/19.png)

:::tip
GPOの内容が反映されない場合  
クライアントPCでコマンドプロンプトを起動し、以下のコマンドで強制的にグループポリシーを適用させて下さい。

```bash
gpupdate /force
```
![ad](./ADIMG5/20.png)
:::


</div>
</details>