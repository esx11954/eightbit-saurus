---
sidebar_position: 12
---

# 11. STP

<details>
    <summary>概要</summary>
    <div>

## STP（スパニングツリープロトコル）

STP（IEEE 802.1D）の目的はただ一つ、**ネットワーク上に形成されるループを論理的に遮断**することです。  
通常ネットワークを止めないために、スイッチ間は複数のケーブルで接続されます（冗長化）。  
しかし、スイッチはこの多重接続をそのままにしておくとデータが無限に回り続ける**ループ構造**と認識してしまい、重大な障害を引き起こします。

STPはこれを防ぐための技術です。

### STPが必要な理由：ループの脅威

ループが発生すると、ネットワークは以下の2つの深刻な問題により機能停止に陥ります。

1.  **ブロードキャストストーム (Broadcast Storm):**
      * ブロードキャストパケット（全端末宛てのデータ）がスイッチのループを通り、無限に増幅・転送され続けます。  
      これにより、ネットワーク帯域が消費され尽くし、すべての通信が停止します。
2.  **MACアドレスフラッピング (MAC Address Flopping):**
      * スイッチが、ある端末のMACアドレスを複数のポートで同時に学習し、MACアドレステーブルの情報が絶えず書き換わり混乱します。その結果、スイッチが正常にフレーム転送できなくなります。

-----

### STPの動作原理

STPは、スイッチ間で**BPDU** (Bridge Protocol Data Unit)という特殊な制御メッセージを交換し、以下の手順で論理的なツリー（木）構造を構築します。

#### ① ルートブリッジの選定

ネットワーク全体で、最も優秀なスイッチである**ルートブリッジ** (Root Bridge)を1台だけ決定します。

  * **選定基準:** **Bridge ID**が最も小さいスイッチが選ばれます。
      * **Bridge ID = プライオリティ値 (Priority) + MACアドレス**
      * 通常、手動でプライオリティ値を低く設定したスイッチがルートブリッジとなります。

#### ② ポートの役割と遮断

ルートブリッジが決まると、すべてのスイッチはルートブリッジへの最も効率的な経路を計算し、その結果に基づいて各ポートに以下の役割を割り当てます。

| ポートの役割 | 役割 | 状態 |
| :--- | :--- | :--- |
| **ルートポート (RP)** | ルートブリッジへの**最短の受信ポート** | **フォワーディング** (データ転送) |
| **指定ポート (DP)** | セグメント（ケーブル）ごとの**最も優秀な送信ポート** | **フォワーディング** (データ転送) |
| **非指定ポート**<br />(Non-Designated) | ルートブリッジへの**冗長なパス（遠回り）** | **ブロッキング** (**論理的に遮断**) |

STPは**非指定ポート**を**ブロッキング状態**にすることで、物理的な接続は維持しつつ論理的なループを切断します。

-----

### ポートの状態の遷移

スイッチのポートは、電源ONからデータ転送（フォワーディング）を開始するまでに、以下の状態を遷移します。

| 状態 | 目的 | データ学習 (MAC) | データ転送 |
| :--- | :--- | :--- | :--- |
| **ブロッキング** (Blocking) | **ループの遮断** | ❌ しない | ❌ しない |
| **リスニング** (Listening) | BPDUを受信・送信し、トポロジ変更を検知 | ❌ しない | ❌ しない |
| **ラーニング** (Learning) | MACアドレステーブルを学習 | ✅ する | ❌ しない |
| **フォワーディング** (Forwarding) | **データ転送** | ✅ する | ✅ する |

### 欠点とRSTP

STPの最も大きな欠点は、障害発生時やトポロジ変更時にデータ転送開始（ブロッキングからフォワーディングへ）までに**約30〜50秒**という長い時間がかかることでした。

そのため、現在では収束時間を大幅に短縮した改良版の**RSTP** (Rapid Spanning Tree Protocol, IEEE 802.1w)が主流となっています。  
RSTPは数秒以内にポートの状態を遷移させることが可能です。



<iframe src="https://drive.google.com/file/d/1-bHLg4P25cGCOy8k-1hi-Gi8tW8iQ7Ty/preview" width="640" height="360" allow="fullscreen"></iframe>
　
## STP動作モードの比較

STPには、標準規格とCisco独自規格があり、主に「**STPインスタンスの数**」と「**収束速度**」によって分類されます。

| モード | 規格 | 特徴 | 収束速度 |
| :--- | :--- | :--- | :--- |
| **CST** (Common STP) | IEEE 802.1D | **ネットワーク全体で1つのSTPインスタンス**を使用。 | 遅い（30〜50秒） |
| **PVST+** (Per-VLAN STP+) | Cisco独自 | **VLANごとに独立したSTPインスタンス**を使用。 | 遅い（30〜50秒） |
| **RSTP** (Rapid STP) | IEEE 802.1w | CSTを改良。**高速な収束**を実現。 | 速い（数秒以内） |
| **Rapid PVST+** | Cisco独自 | **PVST+とRSTPの組み合わせ**。VLANごとに高速収束。 | 最速（数秒以内） |

### PVST+の重要性

**PVST+**（および **Rapid PVST+**）は、Ciscoネットワークで最も一般的に使用されるモードです。

  * **利点:** VLANごとにルートブリッジやポートの状態を独立して選定できるため、VLANごとにトラフィックの経路を最適化し、**アクティブなリンクを有効活用**（ロードバランシング）できます。

-----

## 関連オプション機能（安定性とセキュリティ）

STPを運用する際、特に重要なのがポートを保護するための以下の機能です。

| 機能 | 目的 | 動作 | CCNAでの重要性 |
| :--- | :--- | :--- | :--- |
| **PortFast** | エンドデバイス接続ポートの**高速化** | PCやサーバーなど、ループが発生しないことが確実なポートで、STPの待機時間をスキップし、すぐに**フォワーディング状態**に遷移させる。 | 必須（特にアクセスポート） |
| **BPDU Guard** | **意図しないループの防止** | PortFastが有効なポート（PCが繋がるポート）で、BPDUが受信された場合、不正な接続とみなしポートを即座に**シャットダウン**する。 | 必須（セキュリティ） |
| **Root Guard** | **ルートブリッジの防御** | ネットワークのコア側で設定し、より優秀なBridge IDを持つBPDUを受信した場合、そのポートを**ブロッキング状態**にし、ルートブリッジの変更を防ぐ。 | 高い（コアの保護） |

### よく使用するコマンド例

#### PortFastとBPDU Guardの設定

PortFastを設定する場合は、通常、セキュリティのためにBPDU Guardとセットで設定します。

```cli
Switch# configure terminal
Switch(config)# interface FastEthernet 0/1   // PCが繋がるインターフェース
Switch(config-if)# spanning-tree portfast    // PortFastを有効化
Switch(config-if)# spanning-tree bpduguard enable // BPDU Guardを有効化
Switch(config-if)# end
```

#### 全インターフェースへのグローバル設定

PortFastはアクセスポート全体に適用する方が効率的です。

```cli
Switch(config)# spanning-tree portfast default // 全てのアクセスポートにPortFastをデフォルト適用
```

　
<iframe src="https://drive.google.com/file/d/128je9_4_G4vjS72ZD_Q1d5UKTBja_i1A/preview" width="640" height="360" allow="fullscreen"></iframe>

　

    </div>
</details>

<details>
    <summary>確認問題</summary>
    <div>
以下のファイルをダウンロードし、回答を記入して担当講師に送信して下さい。

[**確認問題**](./files/12.スイッチング_確認課題_名前.xlsx)
    </div>
</details>