---
sidebar_position: 7
---

# 6. ACL・NAT

<details>
    <summary>概要</summary>
    <div>

##  ACLとは

ACL(Access Control List)は、ルーターやスイッチに設定する**パケットをフィルタリング（選別）するためのルールリスト**です。  
ルーターに設定された**関所**として機能し、通過しようとする通信（パケット）を一つ一つチェックし、許可するか拒否するかを判断します。

ACLには大きく分けて2種類あり、**何を基準にチェックするか**によって使い分けられます。

| 種類 | 標準ACL | 拡張ACL |
| :--- | :--- | :--- |
| **ACL番号** | 1 - 99 または 1300 - 1999 | 100 - 199 または 2000 - 2699 |
| **判断基準** | **送信元IPアドレスのみ** | **送信元/宛先IPアドレス、ポート番号、プロトコル** |
| **機能** | 単純なアクセス制限（特定のPCからの通信をすべて拒否など） | 細かい制御（Web閲覧（HTTP: ポート80）だけを許可し、他の通信は拒否するなど） |
| **推奨適用場所** | 宛先に近い場所（ルーターの負荷軽減のため） | 送信元に近い場所 |

---

### 基本的な設定コマンド

ACLの設定は、**リストを作成する**と**インターフェースに適用する**という2つのステップに分かれます。

#### ステップ1：ACLリストの作成

| 目的 | コマンド（例） | 解説 |
| :--- | :--- | :--- |
| **スタンダードACL** | `access-list 1 deny 192.168.1.1` | ACL番号1を作成し、送信元IPアドレス 192.168.1.1 からの通信を拒否。 |
| **スタンダードACL** | `access-list 1 permit any` | その他のすべての通信を許可。（暗黙の拒否を回避するため必須） |
| **エクステンデッドACL** | `access-list 101 permit tcp any host 10.1.1.5 eq 80` | ACL番号101を作成し、どのIPからでも 10.1.1.5 への**TCP/HTTP (ポート80)**通信を許可。 |

#### ステップ2：インターフェースへの適用

| 目的 | コマンド（例） | 解説 |
| :--- | :--- | :--- |
| **ACLの適用** | `ip access-group [ACL番号] [in / out]` | 適用したいインターフェースに入り、作成したACLを適用します。 |
| **in** | **入力時**のパケットをチェック | インターフェースに入ってくる通信をチェックする（主に送信元に近い場所で使う）。 |
| **out** | **出力時**のパケットをチェック | インターフェースから出ていく通信をチェックする（主に宛先に近い場所で使う）。 |

:::tip  確認コマンド
* **`show access-lists`**：作成済みのACLリストの内容と、どのルールが何回マッチしたかを表示します。
:::

:::tip 暗黙の拒否(deny)

ACLのルールリストには、非常に重要な原則があります。

* **上から順にチェック：** ルールはリストの**上から順番に**適用されます。  
一度一致したルールが見つかると、それ以降のルールはチェックされません。
* **リストの最後：** すべてのACLリストの最後には、必ず**`deny any`**という**「リストに記載されていない通信はすべて拒否する」**というルールが**自動的に**追加されています。
    * **重要：** 必要な通信を明示的に `permit`（許可）するのを忘れると、すべて拒否されてしまうため、設定時には注意が必要です。
:::

<iframe src="https://drive.google.com/file/d/1kGoeCJPOsyljalLWNanxIXPHgo_tGAoN/preview" width="640" height="360" allow="fullscreen"></iframe>
　
## NATとは

NATは、ルーターが**プライベートIPアドレス**と**グローバルIPアドレス**を相互に変換する技術です。

:::tip NATの必要性

多くの企業や家庭内のネットワークでは、**プライベートIPアドレス**が使われています。  
しかし、このプライベートIPアドレスはインターネット上では使用できません。

ルーターがNATを行うことで、以下の2つの問題を解決します。
1.  **接続性：** 外部（インターネット）と通信する際、プライベートIPを公的な住所である**グローバルIP**に翻訳し、インターネット上での通信を可能にする。
2.  **IPアドレスの節約：** 複数の端末（PC、スマホなど）が、たった一つのグローバルIPアドレスを共有してインターネットに接続できるようになる。
:::

-----

### NATの主要な種類

NATの変換方法には、大きく分けて以下の2種類があり、特にNAPTが一般的に使われています。

| 種類 | Static NAT<br />（スタティックNAT） | NAPT / PAT<br />（動的 NAPT / PAT） |
| :--- | :--- | :--- |
| **変換方法** | **1対1**の固定変換 | **多対1**の動的変換 |
| **変換例** | Private 1:1 Global | Private 50:1 Global |
| **仕組み** | ある特定のプライベートIPとグローバルIPを**常に固定でペア**にする。 | **ポート番号**も利用して、複数のプライベートIPを**一つのグローバルIP**に変換する。 |
| **利用用途** | サーバーや監視カメラなど、**外部から常に同じIPでアクセスされたい**機器。 | 一般的な**社内PCや家庭内の端末**のインターネットアクセス。 |
| **キーワード** | **固定変換** | **IPマスカレード** / **ポート変換** |

-----

### NAPT（PAT）の仕組み

一般的に使われる**NAPT**（Network Address Port Translation）は、別名**PAT**（Port Address Translation）とも呼ばれ、IPアドレスの節約に最も貢献しています。

NAPTは、IPアドレスだけでなく、通信の識別に使う**ポート番号も一緒に変換**することで、多対一の変換を実現しています。

**【NAPT処理のイメージ】**

| 内部（PC） | ルーター (Inside) | ルーター (Outside) |
| :--- | :--- | :--- |
| **PC-A:** 192.168.1.10:**1000** | → NAPT変換 → | **ルーター:** 203.0.113.5:**20000** |
| **PC-B:** 192.168.1.20:**1000** | → NAPT変換 → | **ルーター:** 203.0.113.5:**20001** |

  * どちらのPCも、ルーターの外側では**同じグローバルIP**（例：203.0.113.5）を使います。
  * ルーターは、**ポート番号**（例：20000 や 20001）を使い分けることで、外から戻ってきたデータがPC-A宛てかPC-B宛てかを正確に判別できます。

-----

## Cisco IOSでの設定概要

Cisco機器でNATを設定する際は、どのインターフェースが**内側**（Inside）で、どのインターフェースが**外側**（Outside）かをルーターに教えてあげることが非常に重要です。

| コマンドの目的 | コマンド（例） | モード | 解説 |
| :--- | :--- | :--- | :--- |
| **内部/外部の定義** | `ip nat inside` / `ip nat outside` | `(config-if)#` | 内部ネットワーク側と外部ネットワーク側のポートにそれぞれ設定します。 |
| **NAPTの設定** | `ip nat inside source list 1 interface [外側インターフェース] overload` |`(config)#` | リスト1（ACL）で定義された内部IPを、外側インターフェースのIPに変換し、ポートを共有する（`overload`）よう設定します。 |


<iframe src="https://drive.google.com/file/d/1GJiFKP7uV8ipaywIEwnep222HdGtbj8Q/preview" width="640" height="360" allow="fullscreen"></iframe>

　

    </div>
</details>

<details>
    <summary>確認問題</summary>
    <div>
以下のファイルをダウンロードし、回答を記入して担当講師に送信して下さい。

[**確認問題**](./files/7.ACL・NAT_確認課題_名前.xlsx)
    </div>
</details>

